<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <title>Context Comparison</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <link rel="stylesheet" type="text/css" media="screen" href="http://www.broadinstitute.org/cogs/cfwork/jqGrid/css/smoothness/jquery-ui-1.8.17.custom.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="http://www.broadinstitute.org/cogs/cfwork/jqGrid/css/ui.jqgrid.css" />
	<link type="text/css" rel="stylesheet" href="http://www.broadinstitute.org//cogs/cfwork/css/bar_styles.css" />
 
	<script src="http://www.broadinstitute.org/cogs/cfwork/js/protovis.js" type="text/javascript"></script>
	<script src="http://www.broadinstitute.org/cogs/cfwork/jqGrid/js/jquery-1.5.2.min.js" type="text/javascript"></script>
	<script src="http://www.broadinstitute.org/cogs/cfwork/jqGrid/js/i18n/grid.locale-en.js" type="text/javascript"></script>
	<script src="http://www.broadinstitute.org/cogs/cfwork/jqGrid/js/jquery.jqGrid.min.js" type="text/javascript"></script>
 	<script src="http://www.broadinstitute.org/cogs/cfwork/js/jquery.sparkline.js" type="text/javascript"></script>
 	<script type="text/javascript" src="http://mbostock.github.com/d3/d3.v2.js"></script>
	<script type="text/javascript" src="http://www.broadinstitute.org/cogs/cfwork/js/d3_simple_bar.js"></script>
 
    <style type="text/css">

#fig {
  width: 880px;
  height: 460px;
}

#title {
  position: absolute;
  top: 70px;
  left: 200px;
  padding: 10px;
  background: white;
}

large {
  font-size: medium;
}

    </style>
  </head>
  <body>
     <table id="connections_table"></table>
     <div id="pager"></div>
     <p></p>
     <div class="d3_bar"></div>
   <script type="text/javascript">
	//table_data
   </script>
   <script type="text/javascript">
   //connections_data
   </script>
   <script type="text/javascript">
   var category_objects = connections[0];
   var category_list = []
   for (var prop in category_objects){
   	if (prop != "name"){
   		category_list.push(prop);
   	}
   };
   
   var string_data = table_data[0].data;
   var float_data = []
	split_data = string_data.split(",");
	for (var i in split_data){
		var split_float = (split_data[i]);
		float_data.push(parseFloat(parseFloat(split_data[i]).toFixed(2)));
	}
	
	//strip out the expected NaN value at the end of the array 
	float_data = float_data.filter(function(val){return !isNaN(val);})
	
	draw_simple_bar("div.d3_bar",200,window.innerWidth-50,float_data,table_data[0].name,category_list);

</script>
   <script type="text/javascript">
	jQuery("#connections_table").jqGrid({
		datatype: "local",
		height: 250,
	   	colNames:['name','data'],
	   	colModel:[
	   		{name:'name',index:'name', width:300, sorttype:""},
	   		{name:'data',index:'data', width:90, sortable:false, formatter:sparkify}		
	   	],
	   	rowNum:30,
	   	rowList:[10,20,30, 40, 50],
	   	caption: "Context Comparison Data Table",
	   	pager: '#pager',
	   	onSelectRow:function(rowid,status){update_bars(rowid);},
	   	loadComplete:function(){jQuery('.spark').sparkline('html',{type:'bar'})},
	});
	
	jQuery('#connections_table').jqGrid('navGrid','#pager',{add:false,edit:false,del:false});
	
	for(var i=0;i<=table_data.length;i++)
		jQuery("#connections_table").jqGrid('addRowData',i+1,table_data[i]);
	
	function sparkify(cellvalue, options, rowObject){
		return '<span class="spark">' + cellvalue + '</span>';
	}
	
	jQuery('.spark').sparkline('html',{type:'bar',chartRangeMin:0, chartRangeMax:20});
	
	
	update_bars(1);
	var string_data = table_data[0].data;
	var data_length = string_data.split(",").length;
	
	function update_bars(rowid){
		var name = jQuery("#connections_table").jqGrid('getCell',rowid,'name');
		for (var i =0; i < table_data.length; i++){
			if (table_data[i].name == name){
				string_data = table_data[i].data; 
			}
		}
		var float_data = []
		split_data = string_data.split(",");
		for (var i in split_data){
			var split_float = (split_data[i]);
			float_data.push(parseFloat(parseFloat(split_data[i]).toFixed(2)));
		}
		
		//strip out the expected NaN value at the end of the array 
		float_data = float_data.filter(function(val){return !isNaN(val);})
		
		//fill in missing values with 0s 
		var missing_num = data_length - float_data.length;
		console.log(missing_num);
		
		for (var i =0; i < missing_num; i++){
			float_data.push(0);
		}
		//update the plot 
		update_simple_bar("div.d3_bar",float_data, name);
	}
	
	</script>
  
  <p>Adjust sliders to filter data</p>
  
  <div id="center"><div id="fig">
    <script type="text/javascript+protovis">

// The units and dimensions to visualize, in order.
var category_objects = connections[0];
var units = new Object;
var units_list = []
for (var prop in category_objects){
	if (prop != "name"){
		units[prop] = {name:prop, unit:""};
		units_list.push(prop);
	}
};
console.log(units_list);

var dims = pv.keys(units);

/* Sizing and scales. */
var w = window.innerWidth-100,
    h = window.innerHeight-200,
    fudge = 0.0,
    x = pv.Scale.ordinal(dims).splitFlush(200, w-200),
    y = pv.dict(dims, function(t) pv.Scale.linear(
        connections.filter(function(d) !isNaN(d[t])),
        function(d) Math.floor(0)-fudge,
        function(d) Math.ceil(20) +fudge
        ).range(0, h)),
    c = pv.dict(dims, function(t) pv.Scale.linear(
        connections.filter(function(d) !isNaN(d[t])),
        function(d) Math.floor(0)-fudge,
        function(d) Math.ceil(20) +fudge
        ).range("steelblue", "brown"));

/* Interaction state. */
var filter = pv.dict(dims, function(t) {
    return {min: y[t].domain()[0], max: y[t].domain()[1]};
  }), active = units_list[0];

/* The root panel. */
var vis = new pv.Panel()
    .width(w)
    .height(h)
    .left(30)
    .right(30)
    .top(30)
    .bottom(20);

// The parallel coordinates display.
vis.add(pv.Panel)
    .data(connections)
    .visible(function(d) dims.every(function(t)
        (d[t] >= filter[t].min) && (d[t] <= filter[t].max)))
  .add(pv.Line)
    .data(dims)
    .left(function(t, d) x(t))
    .bottom(function(t, d) y[t](d[t]))
    .strokeStyle("#ddd")
    .lineWidth(1)
    .antialias(false);
    

// Rule per dimension.
rule = vis.add(pv.Rule)
    .data(dims)
    .left(x);

// Dimension label
rule.anchor("top").add(pv.Label)
    .top(-12)
    .font("bold 10px sans-serif")
    .text(function(d) units[d].name);

// The parallel coordinates display.
var change = vis.add(pv.Panel);

var line = change.add(pv.Panel)
    .data(connections)
    .visible(function(d) dims.every(function(t)
        (d[t] >= filter[t].min) && (d[t] <= filter[t].max)))
  .add(pv.Line)
    .data(dims)
    .left(function(t) x(t))
    .bottom(function(t, i) y[t](i[t]))
    .strokeStyle(function(t, i) c[active](i[active]))
    .lineWidth(2)
    
    
    .add(pv.Label)
    .left(function(t) x(t)+5)
    .text(function(d,i) d=="ppar_sig_anti_diab" ? i.name:"")

//active labels
var activeLabelsHeader = change.add(pv.Label)
	.top(-12)
	.left(0)
    .font("bold 10px sans-serif")
	.text("Active Labels");
var iter=0;
var activeLabels = change.add(pv.Label)
	.data(connections)
	.visible(function(d) dims.every(function(t)
        (d[t] >= filter[t].min) && (d[t] <= filter[t].max)))
	.left(0)
	.bottom(function(d) getLabelIter(d))
	.text(function(d) d.name)
	
function getLabelIter(d) {
	if (dims.every(function(t)
        (d[t] >= filter[t].min) && (d[t] <= filter[t].max))){
		iter++;
	}
	return h-iter*10;
}

// Updater for slider and resizer.
function update(d) {
  var t = d.dim;
  filter[t].min = Math.max(y[t].domain()[0], y[t].invert(h - d.y - d.dy));
  filter[t].max = Math.min(y[t].domain()[1], y[t].invert(h - d.y));
  active = t;
  iter = 0;
  change.render();
  return false;
}

// Updater for slider and resizer.
function selectAll(d) {
  if (d.dy < 3) {
    var t = d.dim;
    filter[t].min = Math.max(y[t].domain()[0], y[t].invert(0));
    filter[t].max = Math.min(y[t].domain()[1], y[t].invert(h));
    d.y = 0; d.dy = h;
    active = t;
    change.render();
  }
    iter = 0;
  return false;
}

/* Handle select and drag */
var handle = change.add(pv.Panel)
    .data(dims.map(function(dim) { return {y:0, dy:h, dim:dim}; }))
    .left(function(t) x(t.dim) - 30)
    .width(60)
    .fillStyle("rgba(0,0,0,.001)")
    .cursor("crosshair")
    .event("mousedown", pv.Behavior.select())
    .event("select", update)
    .event("selectend", selectAll)
  .add(pv.Bar)
    .left(25)
    .top(function(d) d.y)
    .width(10)
    .height(function(d) d.dy)
    .fillStyle(function(t) t.dim == active
        ? c[t.dim]((filter[t.dim].max + filter[t.dim].min) / 2)
        : "hsla(0,0,50%,.5)")
    .strokeStyle("white")
    .cursor("move")
    .event("mousedown", pv.Behavior.drag())
    .event("dragstart", update)
    .event("drag", update);

handle.anchor("bottom").add(pv.Label)
    .textBaseline("top")
    .text(function(d) filter[d.dim].min.toFixed(0) + units[d.dim].unit);

handle.anchor("top").add(pv.Label)
    .textBaseline("bottom")
    .text(function(d) filter[d.dim].max.toFixed(0) + units[d.dim].unit);

vis.render();

    </script>
  </div></div>

  
  
  </body>
</html>